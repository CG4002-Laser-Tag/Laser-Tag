/*
----------------------------------------------------------------------------------
--	(c) Rajesh C Panicker, NUS,
--  Description : AXI Stream Coprocessor (HLS), implementing the sum of 4 numbers
--	License terms :
--	You are free to use this code as long as you
--		(i) DO NOT post a modified version of this on any public repository;
--		(ii) use it only for educational purposes;
--		(iii) accept the responsibility to ensure that your implementation does not violate any intellectual property of any entity.
--		(iv) accept that the program is provided "as is" without warranty of any kind or assurance regarding its suitability for any particular purpose;
--		(v) send an email to rajesh.panicker@ieee.org briefly mentioning its use (except when used for the course EE4218 at the National University of Singapore);
--		(vi) retain this notice in this file or any files derived from this.
----------------------------------------------------------------------------------
*/

//#include "ap_axi_sdata.h" // ap_axis can also be used, but it will include all sideband signals which we don't need
#include "hls_stream.h"
#include "ap_int.h"
#include <math.h>

// Creating a custom structure which includes the data word and TLAST signal.
// ACLK, ARESETN, TREADY, TDATA, TVALID are essential signals for AXIS.
// TLAST is a sideband signal which is optional in AXIS.
// However, it is necessary for us since we connecting M_AXIS to AXI Stream FIFO / AXI DMA.
// So, we create a struct with data (TDATA) and last (TLAST). The rest of the essential AXIS signals are automatically dealt with by the HLS tool.

#define NUMBER_OF_INPUT_WORDS 16  // length of an input vector
#define NUMBER_OF_OUTPUT_WORDS 5  // length of an output vector

#define HIDDEN_LAYER_1_SIZE 32

struct AXIS_wLAST{
	double data;
	bool last;
};

void mlp_solution_hls(hls::stream<AXIS_wLAST>& S_AXIS, hls::stream<AXIS_wLAST>& M_AXIS){
#pragma HLS INTERFACE ap_ctrl_none port=return
#pragma HLS INTERFACE axis port=S_AXIS
#pragma HLS INTERFACE axis port=M_AXIS

	// ====================================== weights ==============================================
	double input_weights[NUMBER_OF_INPUT_WORDS][HIDDEN_LAYER_1_SIZE] = {{0.39385363,0.119069204,0.2797985,0.27542505,0.24263263,-0.44716737,0.15835461,0.19720645,0.26853427,-0.12338525,0.31897467,-0.6505485,0.123415984,-0.014848947,-0.34529486,0.31903294,0.28490064,0.30802935,0.43143457,-0.4337678,-0.022795975,0.0752956,-0.14818741,0.0092355395,-0.1757128,-0.6988153,-0.05802781,-0.21068713,0.23485763,0.24488315,0.4558275,0.08566593},
			{0.041146647,0.16189669,-0.011425303,-0.49556273,0.22379269,-0.71002334,0.16657512,-0.35917464,-0.20209576,0.35297343,0.43022153,-0.21180464,0.8211767,0.17284279,0.8136136,0.2980412,-0.2804991,0.4210706,-0.34113923,-0.19680452,-0.3892227,-0.3271072,0.40951848,0.27820423,0.5310172,0.26831096,0.13045667,0.08349132,-0.46226075,-0.42612463,0.094284944,0.739335},
			{-0.02508549,-0.46776226,0.049247537,-0.5157509,-0.15704845,0.121427,0.25105396,-0.31930152,0.49365836,0.021278683,0.44722092,0.24983382,0.10568109,0.5125587,-0.086562686,0.23426999,0.14031972,0.03970563,-0.017638156,0.14427552,0.13047053,0.19001137,-0.8388304,0.7352588,-0.3918664,-0.26148847,0.3261784,-0.6939667,-0.040918812,-0.09075148,-0.26514837,-0.22894347},
			{0.34985244,0.30323696,0.13167073,-0.4171032,-0.47657922,-0.13101852,-0.25197256,-0.16961585,0.095212236,-0.022675933,-0.13469085,-0.14940482,-0.14958751,0.33053628,-0.17425385,-0.18452041,0.33456025,-0.22143036,-0.11844996,0.32985747,0.44793993,0.12737414,-0.14398094,0.19189902,-0.27232593,-0.25522813,0.0074429098,0.2901898,-0.14967579,-0.07457957,-0.2109429,-0.292428},
			{-0.120272994,-0.57611674,-0.22596739,0.007739164,-0.06590627,-0.45406982,-0.45311558,0.41422,0.33200568,0.75040376,-0.044376153,-0.5392226,0.037046157,-0.4787216,-0.09663128,-0.11945668,0.12173235,-0.5253003,0.275814,-0.6380983,0.448386,0.33818275,0.38313505,-0.09394926,0.6076359,-0.17402312,-0.18537202,-0.006750913,0.35675916,0.54583895,-0.27496606,0.029681867},
			{-0.20317875,0.20357265,0.33492032,-0.109731555,-0.512537,0.17480516,0.27955922,-0.35129765,0.3197381,-0.3777219,0.12458501,0.28006697,-0.015990332,0.13576448,-0.13981912,-0.16398308,-0.4611649,-0.19310118,-0.546659,0.20397255,-0.30745506,0.035325687,-0.102017045,0.21604526,-0.07525427,-0.33837178,0.37678552,0.14878862,-0.18445382,-0.093458585,-0.669083,0.045913696},
			{0.20710106,-0.119467184,0.08885861,-0.15473361,0.45290807,0.3287183,0.08240681,0.002947633,-0.48873514,0.20520937,-0.37250337,0.2998823,-0.25192288,-0.20085217,-0.47831583,-0.34397644,0.3197994,-0.10405338,-0.15029794,0.47571906,-0.030643307,-0.44336382,-0.05626648,-0.38438112,-0.075631246,0.17827125,-0.23805244,-0.29915488,-0.097528644,0.0111049805,0.3522155,-0.14683202},
			{0.49697995,0.24286906,0.08028697,0.14091791,0.12657616,-0.3130488,-0.33541083,-0.036892127,-0.14718273,0.0051696924,0.011877449,0.035446707,-0.09184296,0.36492708,0.029362481,-0.16590993,-0.123284385,-0.3486872,-0.16199972,0.16787921,-0.25356236,-0.3126757,0.21958014,-0.24426503,-0.11194332,-0.27699277,0.25787577,0.02037857,0.0019288289,0.0020435727,-0.062859625,-0.019287515},
			{0.19579495,0.11430069,0.045933627,-0.18535599,0.22575036,0.04207769,0.22379842,-0.04055775,-0.550441,-0.04140041,-0.10351,0.3276978,-0.30510423,0.07418611,-0.27245352,-0.2327297,0.1085107,-0.0020034395,-0.23273523,0.018892817,-0.051523197,-0.3432943,-0.034193367,0.027786152,0.20955007,0.03388961,0.41859448,0.14026226,-0.14099681,-0.056765277,0.17509308,0.14390595},
			{0.05134178,0.19128588,-0.10546337,-0.0038532275,-0.3606885,-0.2005748,-0.05644813,-0.034786645,-0.24967189,-0.13076936,0.08595499,-0.012802616,-0.01964505,0.09314708,0.03810772,0.35920525,0.47785538,0.14962675,0.2995989,0.060607295,0.13127998,-0.14422806,-0.20559014,0.20953134,0.20319651,-0.20926276,0.056788728,0.17620896,0.40934494,0.10784948,0.15803039,0.12307027},
			{0.6078055,-0.030211572,-0.13808489,0.06226465,-0.08362784,-0.027994212,-0.4689285,0.15503901,0.24637765,0.38280833,-0.303324,0.13589108,0.042688765,-0.24359332,-0.09704451,-0.22980358,0.10705059,-0.12697487,0.15451029,0.20533262,0.3700374,0.33707848,-0.1701081,-0.013460339,0.099981986,-0.08158234,-0.05416105,-0.18362665,0.061320864,0.19025952,0.1723078,-0.40910655},
			{0.061622813,-0.12723705,0.046557836,-0.49050236,-0.31299332,0.225289,-0.20740086,-0.39920184,0.08898204,0.14414303,-0.2501809,0.28224063,0.03750702,-0.16236408,0.07336915,-0.37004608,-0.06377721,-0.3928497,-0.08587112,0.3799983,0.26733077,0.13228795,0.11613493,-0.31497827,0.04326397,0.15678702,-0.38849947,0.3364358,-0.15057565,0.14644857,-0.17606331,-0.20614377},
			{0.33440688,-0.008849253,0.17076077,-0.16504472,0.17777535,0.35229155,-0.34923235,-0.41000897,0.06284815,-0.117270276,0.026664643,0.13524179,-0.08544453,-0.29375684,-0.025901936,-0.06508237,-0.19828118,-0.31698835,-0.35693663,0.44115552,-0.46496668,-0.3215575,0.09547147,0.005901011,-0.29111627,0.56235254,0.0109830275,0.14286703,-0.3082223,-0.29344222,0.28860554,-0.15161389},
			{-0.15740815,-0.40076828,-0.41402343,-0.13040642,-0.0026399675,-0.046860702,-0.4950043,0.05312144,-0.09501075,0.13891616,0.10724611,-0.30415538,0.10056882,0.08939906,0.0660803,0.16300169,-0.15818685,-0.051264327,0.042229954,0.04410851,-0.10423192,0.118899256,0.12185871,-0.10060051,0.251955,-0.2115557,-0.07870658,-0.28971222,0.13150649,0.100452535,-0.03233914,0.15667462},
			{0.12343767,0.609248,0.2755739,0.14947411,0.21577318,-0.29964778,0.14417326,0.071468055,-0.041437782,0.245691,-0.27802047,-0.041081782,-0.18377309,-0.0911722,-0.29377747,-0.19322498,0.085096925,-0.26131967,0.055600077,-0.1366642,0.16877955,0.018316314,0.21836063,-0.10486431,0.100043364,0.35938987,0.20384707,-0.029563481,0.17866907,-0.063109264,-0.19016443,-0.057911277},
			{-0.20841113,-0.03663322,0.22770044,-0.2970274,0.1328937,0.09718295,0.16360728,-0.40945375,-0.28099334,-0.26904988,-0.10868208,0.13350554,-0.1948324,-0.047206618,-0.26934668,-0.22113995,-0.31718242,0.22522365,-0.33468556,0.13705452,-0.24839178,0.019671595,-0.29638076,0.1303083,-0.21330501,0.048395425,0.00055810343,0.33512494,-0.33948064,-0.09092546,0.076129004,-0.15597151}};

	double hidden_1_weights[HIDDEN_LAYER_1_SIZE][NUMBER_OF_OUTPUT_WORDS] = {{0.17897975,0.06000333,0.5273755,-0.34827718,-0.017994994},
			{-0.043546468,0.53495336,0.40159383,-0.90929234,-0.01656018},
			{0.025898919,-0.01675271,0.3198315,0.13257775,-0.2966015},
			{0.32410637,-0.23869647,-0.51867896,-0.3932984,0.46507004},
			{0.34502754,0.29349533,0.07239309,-0.4825097,-0.56674755},
			{-0.94239557,-0.7890772,0.7038727,-0.60957426,-0.18481776},
			{-0.14937285,-0.37561736,0.13207743,0.34474686,-0.54898465},
			{0.2418161,-0.043871082,-0.37149745,-0.6361717,0.38709527},
			{-0.28584054,-0.84262,0.11349982,0.017884413,0.3295232},
			{-0.49584317,0.3796888,-0.3689138,-0.481103,0.39624575},
			{-0.0714391,-0.52864677,-0.49178505,0.4696502,-0.13948154},
			{-1.1493485,-0.03201298,0.6194165,-0.32689875,-0.46732298},
			{-0.055978343,0.14741476,-0.84850866,0.34684783,-0.11571834},
			{-0.58494353,-0.33520886,0.1223609,0.30974457,-0.35736015},
			{-1.0642221,0.28034514,-0.20972641,0.09984723,-0.7852343},
			{0.42881313,-0.31070212,-0.7158132,0.45924312,-0.10830985},
			{0.20139739,-0.8034517,0.0033965064,-0.175926,0.14186615},
			{0.4407833,-0.26308447,-0.58012587,0.26674938,-0.5676755},
			{0.24131377,-0.82760584,-0.50635374,-0.3156577,0.40779245},
			{-0.90456516,-0.21937151,0.69856954,-0.22125272,-0.71812904},
			{-0.6636383,-0.41934857,-0.06553176,-0.38161165,0.34596026},
			{-0.572049,-0.618798,0.054947868,0.0076985033,0.41210255},
			{-0.6209682,0.6874949,-0.72858423,-0.47875395,-0.016036047},
			{-0.6796439,-0.41619968,-0.07413573,0.374165,0.08295732},
			{-0.80677193,0.40595013,-0.6640922,-0.133035,-0.020983333},
			{-0.99636847,0.42385697,0.4083673,-0.49120602,-0.4509941},
			{-0.761994,-0.24027479,0.10742488,0.15609439,-0.6586307},
			{-1.0010064,0.3678332,0.101679854,-0.7472645,0.11998629},
			{0.02446671,-0.5379015,-0.567399,-0.211498,0.4941599},
			{-0.09180917,-0.41006806,-0.1761334,-0.46692696,0.28813958},
			{0.6063457,-0.059117228,-0.068350956,-0.51918626,-0.40882164},
			{-0.20575741,0.26260725,-0.55651796,0.2526885,-0.8721684}};

	// =============================== biases ==================================
	double hidden_1_bias[HIDDEN_LAYER_1_SIZE] = {0.07195872,0.07626408,-0.06004515,-0.13390145,0.11768138,-0.0035210701,0.33753514,0.28985214,0.56119597,0.382462,0.23678283,0.4075967,0.61232394,0.060663145,0.3623102,0.31028986,0.1064686,0.15030818,0.51034725,0.12840624,0.31378156,0.62824637,0.53100103,0.2907363,0.11101565,0.27712876,0.18350667,0.5476965,0.150441,0.22428133,-0.2616253,0.49973089};

	double output_bias[NUMBER_OF_OUTPUT_WORDS] = {-0.55365294,-0.13249503,0.17909035,0.06503442,-0.06353929};


	int word_cnt;
	//ap_uint<8> sum = 0; // using arbitrary precision
	//int sum = 0;		 // using 32 bit precision
	double inputs[NUMBER_OF_INPUT_WORDS];
	double hidden1[HIDDEN_LAYER_1_SIZE];
	double output[NUMBER_OF_OUTPUT_WORDS];
	double output_softmax[NUMBER_OF_OUTPUT_WORDS];

	AXIS_wLAST read_input, write_output;

		mlp_solution_hls_for1:for(word_cnt = 0; word_cnt < NUMBER_OF_INPUT_WORDS; word_cnt++){
			read_input = S_AXIS.read();
			// read_input is the element (data + other signals) received by our ip through S_AXIS in one clock cycle (which contains one word).
			// read() extracts it from the stream. Overloaded operator >> can also be used.
			//sum += read_input.data; //extracting that word
			inputs[word_cnt] = read_input.data;
			// We are not making using of S_AXIS_TLAST in this example.
			// S_AXIS_TLAST is required only when we are receiving an unknown number of words.
		}

		// ======================== hidden layer 1 =========================================
		mlp_solution_hls_for2:for(int i = 0; i < HIDDEN_LAYER_1_SIZE; i++) {
			#pragma HLS pipeline II=60

			double connection = 0;
			mlp_solution_hls_label1:for(int j = 0; j < NUMBER_OF_INPUT_WORDS; j++) {
				connection += inputs[j] * input_weights[j][i];
			}
			connection += hidden_1_bias[i];
			hidden1[i] = connection > 0 ? connection : 0.01 * connection;
		}

		// ============================ output layer ===========================================
		mlp_solution_hls_for3:for(int i = 0; i < NUMBER_OF_OUTPUT_WORDS; i++) {
			#pragma HLS pipeline II=80

			double connection = 0;
			mlp_solution_hls_label2:for(int j = 0; j < HIDDEN_LAYER_1_SIZE; j++) {
				connection += hidden1[j] * hidden_1_weights[j][i];
			}
			connection += output_bias[i];
			output[i] = connection;
		}

		// softmax function
		double m = -INFINITY;
		mlp_solution_hls_for4:for (int i = 0; i < NUMBER_OF_OUTPUT_WORDS; i++){
			if (output[i] > m) {
				m = output[i];
			}
		}

		double sum = 0.0;
		mlp_solution_hls_for5:for (int i = 0; i < NUMBER_OF_OUTPUT_WORDS; i++){
			sum += expf(output[i] - m);
		}

		double offset = m + logf(sum);
		mlp_solution_hls_for6:for (int i = 0; i < NUMBER_OF_OUTPUT_WORDS; i++){
			output_softmax[i] = expf(output[i] - offset);
		}

		// ======================== output =========================================
		mlp_solution_hls_for7:for(word_cnt = 0; word_cnt < NUMBER_OF_OUTPUT_WORDS; word_cnt++){
			//write_output.data = sum.to_int();	// using arbitrary precision
			write_output.data = output_softmax[word_cnt];			// using 32 bit precision
			// write_output is the element sent by our ip through M_AXIS in one clock cycle.
			write_output.last = 0;
			if(word_cnt==NUMBER_OF_OUTPUT_WORDS-1)
			{
				write_output.last = 1;
				// M_AXIS_TLAST is required to be asserted for the last word.
				// Else, the AXI Stream FIFO / AXI DMA will not know if all the words have been received from the co-processor.
			}
			M_AXIS.write(write_output);
			// write() inserts it into the stream. Overloaded operator << can also be used.
		}
}
